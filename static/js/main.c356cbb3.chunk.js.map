{"version":3,"sources":["components/NavBar.tsx","components/WrappedRoute.tsx","components/PageHeader.tsx","pm/EditorViewProvider.ts","pm/Observable.ts","pm/PluginStateProvider.ts","pm/Providers.ts","pm/EditorContext.ts","components/usePluginState.ts","pm/active-nodes-marks/index.ts","pm/active-nodes-marks/getActiveMarks.ts","components/Toolbar.tsx","pm/commands.ts","components/SelectUser.tsx","custom-changeset/diff.ts","custom-changeset/span.ts","custom-changeset/change.ts","custom-changeset/changeset.ts","custom-changeset/simplify.ts","pm/track-changes/acceptChange.ts","pm/track-changes/CommentPopUp.tsx","pm/track-changes/renderDecorations.ts","pm/track-changes/track-changes-plugin.ts","components/ChangesList.tsx","components/track-changes-panel/state/TrackChangesContext.ts","components/track-changes-panel/state/recurseDeltas.ts","components/track-changes-panel/state/TrackChangesStore.ts","components/track-changes-panel/TrackChangesBtn.tsx","components/track-changes-panel/change-tree/ChangeNode.tsx","components/track-changes-panel/change-tree/ChangeSummary.tsx","components/track-changes-panel/TrackChangesPanel.tsx","components/track-changes-panel/TrackChangesControls.tsx","components/track-changes-panel/index.tsx","pm/schema.ts","pm/PMEditor.tsx","components/EditorStore.ts","components/Editor.tsx","pages/FrontPage.tsx","routes.tsx","index.tsx"],"names":["NavBar","props","className","Container","Nav","Link","to","exact","activeClassName","styled","div","nav","NavLink","WrappedRoute","Component","component","rest","render","MainWrapper","MainContainer","main","PageHeader","href","EditorViewProvider","_view","view","this","Error","cmd","state","dispatch","focus","hasFocus","tr","scrollIntoView","Observable","_observers","Map","key","cb","current","get","set","Set","add","observers","delete","size","args","Array","from","values","forEach","PluginStateProvider","viewProvider","_observable","p","getState","oldEditorState","newEditorState","entries","oldState","newState","emit","pluginKey","on","off","createDefaultProviders","pluginStateProvider","ReactEditorContext","createContext","useEditorContext","useContext","usePluginState","useState","getPluginState","setState","useEffect","pluginState","activeNodesMarksPluginKey","PluginKey","activeNodesMarksPlugin","Plugin","init","config","activeNodes","activeMarks","apply","docChanged","selectionSet","marks","selection","empty","$from","storedMarks","map","mark","type","name","$head","$anchor","getActiveMarks","every","m","includes","length","marksIcons","title","icon","commandIcons","Toolbar","handleIconClick","execCommand","toggleMark","schema","bold","italic","cursor","head","blockNodePos","doc","resolve","start","setNodeMarkup","undefined","dataTracked","Math","random","toString","IconList","item","IconItem","IconButton","onClick","ul","li","button","SelectUser","userID","setUserID","handleSelectUser","id","setMeta","Button","tokens","frag","end","target","i","childCount","child","endOff","nodeSize","max","min","isText","text","j","push","charCodeAt","isLeaf","content","computeDiff","fragA","fragB","range","tokA","fromA","toA","tokB","fromB","toB","endA","endB","slice","lenA","lenB","history","frontier","len","diag","next","prev","x","y","sizeA","sizeB","diff","minSpan","floor","fA","tA","fB","tB","reverse","Span","data","spans","none","result","span","overlap","cut","a","b","combine","combined","concat","Change","deleted","inserted","blockInserted","find","s","blockChange","blockDeleted","startA","startB","iX","iY","curX","curY","pos","enteredX","enteredY","nextX","nextY","inX","inY","join","ChangeSet","changes","newDoc","steps","stepChanges","step","d","isArray","ReplaceStep","console","log","ReplaceAroundStep","AddMarkStep","RemoveMarkStep","error","newChanges","mergeAll","merge","change","some","r","splice","insideReplaceAroundStep","getMap","f","maps","touched","endRange","invert","touchedRange","moved","rA","rB","iA","iB","rangeA","rangeB","sameRanges","ranges","mid","_s","_e","sameSpans","RegExp","_","wrapWithNode","wrapperNode","startPos","node","nodeAt","blockRange","wrapping","findWrapping","attrs","wrap","liftNode","targetDepth","Number","liftTarget","isNaN","lift","acceptChange","changeIndex","oldChangeSet","startState","currentState","wasBlockChange","isBlockChangeStart","insertOnly","acceptedChange","beforeChanges","offset","toBlockChangeEnd","afterChanges","c","isBlockChangeEnd","filter","updateChangesWithBlockChange","replaceWith","updateChanges","CommentPopUp","comments","onClose","onAccept","onReject","onSubmitReply","reply","setReply","CornerX","CloseIconBtn","List","Item","UserInfo","Name","author","Time","timeStr","user","ReplyInput","placeholder","value","onChange","e","Buttons","AcceptBtn","time","input","renderDecorations","changeSet","userColors","domSerializer","decorations","allDeletionsLength","allInsertsLength","index","insertFrom","changeType","spanLength","colors","style","Decoration","inline","deletionsLength","html","serializeFragment","widget","getPos","element","document","createElement","appendChild","Object","keys","setAttribute","deletedWidget","side","strikethrough","create","trackChangesPluginKey","colorScheme","trackChangesPlugin","renderedPopper","popUpElement","querySelector","cached","DOMSerializer","fromSchema","decorationSet","DecorationSet","getMeta","oldStartState","acceptedChangeIndex","addSteps","has","appendTransaction","trs","_oldState","rejectedChangeTr","rejectedChangeIndex","trackState","deleteOnly","rejectChange","handleClickOn","_pos","_node","_nodePos","event","_direct","el","dataChangeIndex","getAttribute","dataChangeType","textBetween","startDoc","container","popper","createPopper","placement","destroy","unmountComponentAtNode","renderCommentPopUp","Promise","ChangesList","trackChangesState","changeTitle","CommitItem","TitleWrapper","idx","Ranges","TrackChangesContext","getArrayDeltaType","val","isMove","isTextDiff","isInsert","getNode","path","recurseDeltas","delta","pmNode","depth","originalDoc","parent","treeMap","treeNode","children","createNode","wasArrayDelta","msg","wasMoveOrDelete","charAt","parseInt","substr","arrayDelta","childPath","foundNode","childTreeNode","TrackChangesStore","currentDoc","origDoc","DiffPatcher","objectHash","arrays","detectMove","includeValueOnMove","textDiff","minLength","toJSON","changeTree","tree","pruned","recurse","n","JSON","stringify","print","TrackChangesBtn","TrackChangesBtnWrapper","ChangeNode","ChangeItem","ShowBtn","active","ChangeSummary","TrackChangesPanel","setChangeTree","store","Wrapper","TopRow","TrackChangesControls","setActive","CONTAINER_CLASS_NAME","injectTrackChanges","place","body","createOrFindPlace","ReactDOM","Provider","Schema","nodes","paragraph","default","group","parseDOM","tag","toDOM","blockquote","defining","horizontal_rule","heading","level","code_block","code","preserveWhitespace","image","src","alt","draggable","getAttrs","dom","hard_break","selectable","link","inclusive","fontWeight","test","PMEditor","editorViewRef","useRef","editorRef","ctx","dispatchTransaction","transaction","editorState","updateState","updatePluginListeners","onEdit","useLayoutEffect","EditorState","plugins","exampleSetup","editorViewDOM","EditorView","mount","window","editorView","createEditorView","onEditorReady","ref","EditorStore","jsonEditorState","localStorageKey","setEditorView","fromJSON","syncCurrentEditorState","localStorage","setItem","existing","getItem","stored","parse","Editor","editorStore","useMemo","debouncedSync","debounce","EditorWrapper","applyDevTools","FrontPage","Routes","basename","process","getElementById"],"mappings":"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","file":"static/js/main.c356cbb3.chunk.js","sourcesContent":["import React from 'react'\nimport { NavLink } from 'react-router-dom'\nimport styled from 'styled-components'\n\nimport { RouteComponentProps } from 'react-router'\n\ninterface IProps extends RouteComponentProps<{}> {\n  className?: string\n}\n\nexport const NavBar = (props: IProps) => {\n  const { className} = props\n  return (\n    <Container className={className}>\n      <Nav>\n        <Link to=\"/\" exact activeClassName=\"current\">Front page</Link>\n      </Nav>\n    </Container>\n  )\n}\n\nconst Container = styled.div`\n  background: var(--color-primary);\n  box-shadow: 0 0 2px 2px rgba(0,0,0,0.18);\n  padding: 1rem;\n`\nconst Nav = styled.nav`\n  align-items: center;\n  color: #fff;\n  display: flex;\n  justify-content: space-between;\n`\nconst Link = styled(NavLink)`\n  box-sizing: border-box;\n  color: #fff;\n  cursor: pointer;\n  font-size: 1rem;\n  padding: 0.5rem 1rem;\n  text-decoration: none;\n  transition: 0.2s hover;\n  &:hover {\n    text-decoration: underline;\n  }\n  &.current {\n    font-weight: 600;\n  }\n`\n","import * as React from 'react'\nimport { Route, RouteProps, RouteComponentProps } from 'react-router'\nimport styled from 'styled-components'\n\nimport { NavBar } from './NavBar'\n\ntype ReactComponent = React.ComponentClass<any> | React.StatelessComponent<any>\n\ninterface IWrappedRoute extends RouteProps {\n  component: ReactComponent\n}\n\nconst renderNoMainContainerWrapper = (Component: ReactComponent) => (props: RouteComponentProps<any>) =>\n  <MainWrapper>\n    <NavBar {...props}/>\n    <Component {...props}/>\n  </MainWrapper>\n\nconst renderWrapper = (Component: ReactComponent) => (props: RouteComponentProps<any>) =>\n  <MainWrapper>\n    <NavBar {...props}/>\n    <MainContainer>\n      <Component {...props}/>\n    </MainContainer>\n  </MainWrapper>\n\nexport const NoMainContainerRoute = ({ component, ...rest } : IWrappedRoute) =>\n  <Route {...rest} render={renderNoMainContainerWrapper(component)}/>\n\nexport const WrappedRoute = ({ component, ...rest } : IWrappedRoute) =>\n  <Route {...rest} render={renderWrapper(component)}/>\n\nconst MainWrapper = styled.div`\n  min-height: 100vh;\n`\nconst MainContainer = styled.main`\n  margin: 40px auto 0 auto;\n  max-width: 800px;\n  padding-bottom: 20px;\n  @media only screen and (max-width: 720px) {\n    margin: 40px 20px 0 20px;\n    padding-bottom: 20px;\n  }\n`\n","import * as React from 'react'\nimport styled from 'styled-components'\n\ninterface IProps {\n  className?: string\n}\n\nexport function PageHeader(props: IProps) {\n  const { className } = props\n  return (\n    <Container className={className}>\n      <header>\n        <h1><a href=\"https://teemukoivisto.github.io/prosemirror-track-changes-example/\">\n          Track changes example</a></h1>\n        <p>With prosemirror-changeset</p>\n        <p><a href=\"https://github.com/TeemuKoivisto/prosemirror-track-changes-example\">Github repo</a></p>\n      </header>\n    </Container>\n  )\n}\n\nconst Container = styled.div`\n`\n","import { EditorView } from 'prosemirror-view'\nimport { ExampleSchema } from './schema'\n\nimport { Command } from './editor-types'\n\nexport class EditorViewProvider {\n  _view?: EditorView<ExampleSchema>\n\n  init(view: EditorView<ExampleSchema>) {\n    this._view = view\n  }\n\n  get view(): EditorView<ExampleSchema> {\n    if (!this._view) {\n      throw Error('EditorViewProvider view accessed without EditorView instance')\n    }\n    return this._view\n  }\n\n  execCommand(cmd: Command) {\n    cmd(this.view.state, this.view.dispatch)\n    this.focus()\n  }\n\n  focus() {\n    if (!this._view || this._view.hasFocus()) {\n      return false\n    }\n    this._view.focus()\n    this._view.dispatch(this._view.state.tr.scrollIntoView())\n    return true\n  }\n}","/**\n * Modified from https://github.com/dmonad/lib0/blob/main/observable.js\n */\nexport class Observable<K = string> {\n  _observers = new Map<K, Set<(args: any[]) => void>>()\n\n  on(key: K, cb: (...args: any[]) => void) {\n    const current = this._observers.get(key)\n    if (current) {\n      this._observers.set(key, new Set(current.add(cb)))\n    } else {\n      this._observers.set(key, new Set([cb]))\n    }\n  }\n\n  off(key: K, cb: (...args: any[]) => void) {\n    const observers = this._observers.get(key)\n    if (observers) {\n      observers.delete(cb)\n      if (observers.size === 0) {\n        this._observers.delete(key)\n      }\n    }\n  }\n\n  emit(key: K, ...args: any[]) {\n    // TODO the typing of this annoying thing\n    // @ts-ignore\n    return Array.from((this._observers.get(key) || new Set()).values()).forEach(cb => cb(...args))\n  }\n\n  destroy() {\n    this._observers = new Map()\n  }\n}","import { EditorState, PluginKey } from 'prosemirror-state'\nimport { EditorViewProvider } from './EditorViewProvider'\nimport { Observable } from './Observable'\n\nexport class PluginStateProvider {\n\n  _observable = new Observable<PluginKey>()\n  viewProvider: EditorViewProvider\n\n  constructor(viewProvider: EditorViewProvider) {\n    this.viewProvider = viewProvider\n  }\n\n  getPluginState(p: PluginKey) {\n    if (this.viewProvider._view) {\n      return p.getState(this.viewProvider.view.state)\n    }\n    return null\n  }\n\n  updatePluginListeners(oldEditorState: EditorState, newEditorState: EditorState) {\n    Array.from(this._observable._observers.entries()).forEach(([p, subscribers]) => {\n      const oldState = p.getState(oldEditorState)\n      const newState = p.getState(newEditorState)\n      if (oldState !== newState) {\n        this._observable.emit(p, newState)\n      }\n    })\n  }\n\n  on(pluginKey: PluginKey, cb: (data: any) => void) {\n    this._observable.on(pluginKey, cb)\n  }\n\n  off(pluginKey: PluginKey, cb: (data: any) => void) {\n    this._observable.off(pluginKey, cb)\n  }\n}\n","import { EditorViewProvider } from './EditorViewProvider'\nimport { PluginStateProvider } from './PluginStateProvider'\n\nexport interface IProviders {\n  viewProvider: EditorViewProvider\n  pluginStateProvider: PluginStateProvider\n}\n\nexport const createDefaultProviders = (): IProviders => {\n  const viewProvider = new EditorViewProvider()\n  const pluginStateProvider = new PluginStateProvider(viewProvider)\n  return {\n    viewProvider,\n    pluginStateProvider,\n  }\n}\n","import { createContext, useContext } from 'react'\nimport { IProviders, createDefaultProviders } from './Providers'\n\nexport type EditorContext = IProviders\n\nexport const ReactEditorContext = createContext<EditorContext>(createDefaultProviders())\n\nexport const useEditorContext = () => useContext(ReactEditorContext)\n","import { useState, useEffect } from 'react'\nimport { PluginKey } from 'prosemirror-state'\n\nimport { useEditorContext } from 'pm/EditorContext'\n\nexport function usePluginState<T>(pluginKey: PluginKey) {\n  const { pluginStateProvider } = useEditorContext()\n\n  const [state, setState] = useState<T | null>(pluginStateProvider.getPluginState(pluginKey))\n\n  useEffect(() => {\n    const cb = (pluginState: T) => {\n      setState(pluginState)\n    }\n    pluginStateProvider.on(pluginKey, cb)\n    return () => {\n      pluginStateProvider.off(pluginKey, cb)\n    }\n  }, [pluginKey, pluginStateProvider])\n\n  return state\n}\n","import { Plugin, PluginKey } from 'prosemirror-state'\n\nimport { getActiveMarks } from './getActiveMarks'\n\nimport { ExampleSchema } from '../schema'\n\nexport interface ActiveNodesMarksState {\n  activeNodes: string[]\n  activeMarks: string[]\n}\n\nexport const activeNodesMarksPluginKey = new PluginKey<ActiveNodesMarksState, ExampleSchema>('active-nodes-marks')\n\nexport const activeNodesMarksPlugin = () => {\n  return new Plugin<ActiveNodesMarksState, ExampleSchema>({\n    key: activeNodesMarksPluginKey,\n    state: {\n      init(config, state) {\n        return {\n          activeNodes: [],\n          activeMarks: [],\n        }\n      },\n\n      apply(tr, pluginState, oldState, newState) {\n        if (tr.docChanged || tr.selectionSet) {\n          const marks = getActiveMarks(newState)\n          const eqMarks = marks.every(m => pluginState.activeMarks.includes(m)) && marks.length === pluginState.activeMarks.length\n          if (!eqMarks) {\n            const nextPluginState = {\n              ...pluginState,\n              activeMarks: marks,\n            }\n            return nextPluginState\n          }\n        }\n        return pluginState\n      },\n    },\n  })\n}\n","\nimport { EditorState } from 'prosemirror-state'\n\n// From https://github.com/PierBover/prosemirror-cookbook\nexport function getActiveMarks(state: EditorState): string[] {\n  if (state.selection.empty) {\n    const $from = state.selection.$from\n    const storedMarks = state.storedMarks\n\n    // Return either the stored marks, or the marks at the cursor position.\n    // Stored marks are the marks that are going to be applied to the next input\n    // if you dispatched a mark toggle with an empty cursor.\n    if (storedMarks) {\n      return storedMarks.map(mark => mark.type.name)\n    } else {\n      return $from.marks().map(mark => mark.type.name)\n    }\n  } else {\n    const $head = state.selection.$head\n    const $anchor = state.selection.$anchor\n\n    // We're using a Set to not get duplicate values\n    const activeMarks = new Set<string>()\n\n    // Here we're getting the marks at the head and anchor of the selection\n    $head.marks().forEach(mark => activeMarks.add(mark.type.name))\n    $anchor.marks().forEach(mark => activeMarks.add(mark.type.name))\n\n    return Array.from(activeMarks)\n  }\n}\n","import React from 'react'\nimport styled from 'styled-components'\nimport { toggleMark } from 'prosemirror-commands'\n\nimport {\n  FiBold, FiItalic, FiAtSign\n} from 'react-icons/fi'\nimport { GrBlockQuote } from 'react-icons/gr'\n\nimport { useEditorContext } from 'pm/EditorContext'\nimport { usePluginState } from './usePluginState'\nimport { activeNodesMarksPluginKey, ActiveNodesMarksState } from 'pm/active-nodes-marks'\nimport { setBlockNodeAttribute } from 'pm/commands'\n\ntype IconType = 'bold' | 'italic' | 'toggle-blockquote' | 'update-attribute'\n\nconst marksIcons: {\n  title: IconType\n  icon: React.ReactNode\n}[] = [\n  {\n    title: 'bold',\n    icon: <FiBold size={16} />\n  },\n  {\n    title: 'italic',\n    icon: <FiItalic size={16}/>\n  },\n]\n\nconst commandIcons: {\n  title: IconType\n  icon: React.ReactNode\n}[] = [\n  {\n    title: 'toggle-blockquote',\n    icon: <GrBlockQuote size={16}/>\n  },\n  {\n    title: 'update-attribute',\n    icon: <FiAtSign size={16} />\n  }\n]\n\nexport function Toolbar() {\n  const { viewProvider } = useEditorContext()\n  const activeNodesMarksPlugin = usePluginState<ActiveNodesMarksState>(activeNodesMarksPluginKey)\n\n  function handleIconClick(title: IconType) {\n    switch (title) {\n      case 'bold':\n        viewProvider.execCommand(toggleMark(viewProvider.view.state.schema.marks.bold))\n        return\n      case 'italic':\n        viewProvider.execCommand(toggleMark(viewProvider.view.state.schema.marks.italic))\n        return\n      case 'toggle-blockquote':\n        return\n      case 'update-attribute':\n        viewProvider.execCommand(setBlockNodeAttribute())\n        return\n    }\n  }\n  return (\n    <Container>\n      <IconList>\n        {marksIcons.map(item =>\n          <IconItem key={item.title}>\n            <IconButton\n              className={`${activeNodesMarksPlugin?.activeMarks.includes(item.title) ? 'active' : ''}`}\n              onClick={() => handleIconClick(item.title)}\n            >\n              {item.icon}\n            </IconButton>\n          </IconItem>\n        )}\n        {commandIcons.map(item =>\n          <IconItem key={item.title}>\n            <IconButton onClick={() => handleIconClick(item.title)}>\n              {item.icon}\n            </IconButton>\n          </IconItem>\n        )}\n      </IconList>\n    </Container>\n  )\n}\n\nconst Container = styled.div`\n  background: var(--color-primary-lighter);\n  padding: 1rem;\n`\nconst IconList = styled.ul`\n  align-items: center;\n  color: #fff;\n  display: flex;\n  list-style: none;\n  margin: 0;\n  padding: 0;\n`\nconst IconItem = styled.li`\n  & + & {\n    margin-left: 1rem;\n  }\n`\nconst IconButton = styled.button`\n  align-items: center;\n  background: transparent;\n  border: 0;\n  border-radius: 4px;\n  cursor: pointer;\n  display: flex;\n  padding: 0.25rem;\n  &:hover {\n    background: rgba(255, 255, 255, 0.7);\n    opacity: 0.7;\n  }\n  &.active {\n    background: rgb(215 227 255);\n    box-shadow: 0 0 2px 2px rgb(0 0 0 / 18%);\n  }\n`\n","import type { Command } from './editor-types'\n\nexport const setBlockNodeAttribute = () : Command => (state, dispatch) => {\n  const cursor = state.selection.head\n  const blockNodePos = state.doc.resolve(cursor).start(1) - 1\n  const tr = state.tr.setNodeMarkup(blockNodePos, undefined, { dataTracked: Math.random().toString() })\n  if (dispatch) {\n    dispatch(tr)\n    return true\n  }\n  return false\n}","import React, { useState } from 'react'\nimport styled from 'styled-components'\n\nimport { useEditorContext } from 'pm/EditorContext'\n\ninterface IProps {\n  className?: string\n}\n\nexport function SelectUser(props: IProps) {\n  const { className } = props\n  const [userID, setUserID] = useState('1')\n  const { viewProvider } = useEditorContext()\n\n  function handleSelectUser(id: string) {\n    const view = viewProvider.view\n    view.dispatch(view.state.tr.setMeta('set-userID', id))\n    setUserID(id)\n  }\n  return (\n    <Container className={className}>\n      <div className=\"current-user\">\n        Current user: {userID}\n      </div>\n      <div>\n        <Button onClick={() => handleSelectUser('1')}>User 1</Button>\n        <Button onClick={() => handleSelectUser('2')}>User 2</Button>\n        <Button onClick={() => handleSelectUser('3')}>User 3</Button>\n      </div>\n    </Container>\n  )\n}\n\nconst Container = styled.div`\n  align-items: center;\n  display: flex;\n  .current-user {\n    margin: 0.25rem 1rem 0.25rem 0;\n  }\n`\nconst Button = styled.button`\n  cursor: pointer;\n  & + & {\n    margin-left: 0.5rem;\n  }\n`","/* eslint-disable */\n\nimport { Fragment } from \"prosemirror-model\"\n\nimport { Change } from './change'\n\n// Convert the given range of a fragment to tokens, where node open\n// tokens are encoded as strings holding the node name, characters as\n// their character code, and node close tokens as -1.\nfunction tokens(frag: Fragment, start: number, end: number, target: (number | string)[]) {\n  for (let i = 0, off = 0; i < frag.childCount; i++) {\n    let child = frag.child(i), endOff = off + child.nodeSize\n    let from = Math.max(off, start), to = Math.min(endOff, end)\n    if (from < to) {\n      if (child.isText && child.text) {\n        for (let j = from; j < to; j++) target.push(child.text.charCodeAt(j - off))\n      } else if (child.isLeaf) {\n        target.push(child.type.name)\n      } else {\n        if (from == off) target.push(child.type.name)\n        tokens(child.content, Math.max(off + 1, from) - off - 1, Math.min(endOff - 1, to) - off - 1, target)\n        if (to == endOff) target.push(-1)\n      }\n    }\n    off = endOff\n  }\n  return target\n}\n\n// The code below will refuse to compute a diff with more than 5000\n// insertions or deletions, which takes about 300ms to reach on my\n// machine. This is a safeguard against runaway computations.\nconst MAX_DIFF_SIZE = 5000\n\n// This obscure mess of constants computes the minimum length of an\n// unchanged range (not at the start/end of the compared content). The\n// idea is to make it higher in bigger replacements, so that you don't\n// get a diff soup of coincidentally identical letters when replacing\n// a paragraph.\nfunction minUnchanged(sizeA: number, sizeB: number) {\n  return Math.min(15, Math.max(2, Math.floor(Math.max(sizeA, sizeB) / 10)))\n}\n\n// : (Fragment, Fragment, Change) → [Change]\nexport function computeDiff(fragA: Fragment, fragB: Fragment, range: Change) {\n  let tokA = tokens(fragA, range.fromA, range.toA, [])\n  let tokB = tokens(fragB, range.fromB, range.toB, [])\n\n  // Scan from both sides to cheaply eliminate work\n  let start = 0, endA = tokA.length, endB = tokB.length\n  while (start < tokA.length && start < tokB.length && tokA[start] === tokB[start]) start++\n  if (start == tokA.length && start == tokB.length) return []\n  while (endA > start && endB > start && tokA[endA - 1] === tokB[endB - 1]) endA--, endB--\n  // If the result is simple _or_ too big to cheaply compute, return\n  // the remaining region as the diff\n  if (endA == start || endB == start || (endA == endB && endA == start + 1))\n    return [range.slice(start, endA, start, endB)]\n\n  // This is an implementation of Myers' diff algorithm\n  // See https://neil.fraser.name/writing/diff/myers.pdf and\n  // https://blog.jcoglan.com/2017/02/12/the-myers-diff-algorithm-part-1/\n\n  let lenA = endA - start, lenB = endB - start\n  let max = Math.min(MAX_DIFF_SIZE, lenA + lenB), off = max + 1\n  let history: number[][] = []\n  let frontier: number[] = []\n  for (let len = off * 2, i = 0; i < len; i++) frontier[i] = -1\n\n  for (let size = 0; size <= max; size++) {\n    for (let diag = -size; diag <= size; diag += 2) {\n      let next = frontier[diag + 1 + max], prev = frontier[diag - 1 + max]\n      let x = next < prev ? prev : next + 1, y = x + diag\n      while (x < lenA && y < lenB && tokA[start + x] === tokB[start + y]) x++, y++\n      frontier[diag + max] = x\n      // Found a match\n      if (x >= lenA && y >= lenB) {\n        // Trace back through the history to build up a set of changed ranges.\n        let diff = [], minSpan = minUnchanged(endA - start, endB - start)\n        // Used to add steps to a diff one at a time, back to front, merging\n        // ones that are less than minSpan tokens apart\n        let fromA = -1, toA = -1, fromB = -1, toB = -1\n        let add = (fA: number, tA: number, fB: number, tB: number) => {\n          if (fromA > -1 && fromA < tA + minSpan) {\n            fromA = fA; fromB = fB\n          } else {\n            if (fromA > -1)\n              diff.push(range.slice(fromA, toA, fromB, toB))\n            fromA = fA; toA = tA\n            fromB = fB; toB = tB\n          }\n        }\n\n        for (let i = size - 1; i >= 0; i--) {\n          let next = frontier[diag + 1 + max], prev = frontier[diag - 1 + max]\n          if (next < prev) { // Deletion\n            diag--\n            x = prev + start; y = x + diag\n            add(x, x, y, y + 1)\n          } else { // Insertion\n            diag++\n            x = next + start; y = x + diag\n            add(x, x + 1, y, y)\n          }\n          frontier = history[i >> 1]\n        }\n        if (fromA > -1) diff.push(range.slice(fromA, toA, fromB, toB))\n        return diff.reverse()\n      }\n    }\n    // Since only either odd or even diagonals are read from each\n    // frontier, we only copy them every other iteration.\n    if (size % 2 == 0) history.push(frontier.slice())\n  }\n  // The loop exited, meaning the maximum amount of work was done.\n  // Just return a change spanning the entire range.\n  return [range.slice(start, endA, start, endB)]\n}","/* eslint-disable */\n\n// ::- Stores metadata for a part of a change.\nexport class Span {\n\n  length: number\n  data: any\n\n  constructor(length: number, data?: any) {\n    // :: number\n    this.length = length\n    // :: any\n    this.data = data\n  }\n\n  cut(length: number) {\n    return length == this.length ? this : new Span(length, this.data)\n  }\n\n  static slice(spans: Span[], from: number, to: number) {\n    if (from == to) return Span.none\n    if (from == 0 && to == Span.len(spans)) return spans\n    let result = []\n    for (let i = 0, off = 0; off < to; i++) {\n      let span = spans[i], end = off + span.length\n      let overlap = Math.min(to, end) - Math.max(from, off)\n      if (overlap > 0) result.push(span.cut(overlap))\n      off = end\n    }\n    return result\n  }\n\n  static join(a: Span[], b: Span[], combine: (data1: any, data2: any) => any) {\n    if (a.length == 0) return b\n    if (b.length == 0) return a\n    let combined = combine(a[a.length - 1].data, b[0].data)\n    if (combined == null) return a.concat(b)\n    let result = a.slice(0, a.length - 1)\n    result.push(new Span(a[a.length - 1].length + b[0].length, combined))\n    for (let i = 1; i < b.length; i++) result.push(b[i])\n    return result\n  }\n\n  static len(spans: Span[]) {\n    let len = 0\n    for (let i = 0; i < spans.length; i++) len += spans[i].length\n    return len\n  }\n\n  static get none() : Span[] {\n    return []\n  }\n}\n\n// Span.none = []","/* eslint-disable */\n\nimport { Span } from './span'\n\n// ::- A replaced range with metadata associated with it.\nexport class Change {\n  \n  fromA: number\n  toA: number\n  fromB: number\n  toB: number\n  deleted: Span[]\n  inserted: Span[]\n\n  constructor(fromA: number, toA: number, fromB: number, toB: number, deleted: Span[], inserted: Span[]) {\n    // :: number The start of the range deleted/replaced in the old\n    // document.\n    this.fromA = fromA\n    // :: number The end of the range in the old document.\n    this.toA = toA\n    // :: number The start of the range inserted in the new document.\n    this.fromB = fromB\n    // :: number The end of the range in the new document.\n    this.toB = toB\n    // :: [Span] Data associated with the deleted content. The length\n    // of these spans adds up to `this.toA - this.fromA`.\n    this.deleted = deleted\n    // :: [Span] Data associated with the inserted content. Length\n    // adds up to `this.toB - this.toA`.\n    this.inserted = inserted\n  }\n\n  get lenA() { return this.toA - this.fromA }\n  get lenB() { return this.toB - this.fromB }\n\n  get blockChange() {\n    const blockInserted = this.inserted.find(s => s.data?.blockChange)\n    const blockDeleted = this.deleted.find(s => s.data?.blockChange)\n    if (blockInserted) return blockInserted.data.blockChange\n    if (blockDeleted) return blockDeleted.data.blockChange\n    return null\n  }\n  \n  get isBlockChangeStart() {\n    const blockInserted = this.inserted.find(s => s.data?.blockChange)\n    const blockDeleted = this.deleted.find(s => s.data?.blockChange)\n    return blockInserted?.data?.blockChange === 'start' || blockDeleted?.data?.blockChange === 'start'\n  }\n\n  get isBlockChangeEnd() {\n    const blockInserted = this.inserted.find(s => s.data?.blockChange)\n    const blockDeleted = this.deleted.find(s => s.data?.blockChange)\n    return blockInserted?.data?.blockChange === 'end' || blockDeleted?.data?.blockChange === 'end'\n  }\n\n  slice(startA: number, endA: number, startB: number, endB: number) {\n    if (startA == 0 && startB == 0 && endA == this.toA - this.fromA &&\n        endB == this.toB - this.fromB) return this\n    return new Change(this.fromA + startA, this.fromA + endA,\n                      this.fromB + startB, this.fromB + endB,\n                      Span.slice(this.deleted, startA, endA),\n                      Span.slice(this.inserted, startB, endB))\n  }\n\n  // : ([Change], [Change], (any, any) → any) → [Change]\n  // This merges two changesets (the end document of x should be the\n  // start document of y) into a single one spanning the start of x to\n  // the end of y.\n  static merge(x: Change[], y: Change[], combine: (a: any, b: any) => any) : Change[] {\n    if (x.length == 0) return y\n    if (y.length == 0) return x\n\n    let result = []\n    // Iterate over both sets in parallel, using the middle coordinate\n    // system (B in x, A in y) to synchronize.\n    for (let iX = 0, iY = 0, curX: Change = x[0], curY: Change = y[0];;) {\n      if (!curX && !curY) {\n        return result\n      } else if (curX && (!curY || curX.toB < curY.fromA)) { // curX entirely in front of curY\n        let off = iY ? y[iY - 1].toB - y[iY - 1].toA : 0\n        result.push(off == 0 ? curX :\n                    new Change(curX.fromA, curX.toA, curX.fromB + off, curX.toB + off,\n                               curX.deleted, curX.inserted))\n        // @ts-ignore\n        curX = iX++ == x.length ? null : x[iX]\n      } else if (curY && (!curX || curY.toA < curX.fromB)) { // curY entirely in front of curX\n        let off = iX ? x[iX - 1].toB - x[iX - 1].toA : 0\n        result.push(off == 0 ? curY :\n                    new Change(curY.fromA - off, curY.toA - off, curY.fromB, curY.toB,\n                               curY.deleted, curY.inserted))\n        // @ts-ignore\n        curY = iY++ == y.length ? null : y[iY]\n      } else { // Touch, need to merge\n        // The rules for merging ranges are that deletions from the\n        // old set and insertions from the new are kept. Areas of the\n        // middle document covered by a but not by b are insertions\n        // from a that need to be added, and areas covered by b but\n        // not a are deletions from b that need to be added.\n        let pos = Math.min(curX.fromB, curY.fromA)\n        let fromA = Math.min(curX.fromA, curY.fromA - (iX ? x[iX - 1].toB - x[iX - 1].toA : 0)), toA = fromA\n        let fromB = Math.min(curY.fromB, curX.fromB + (iY ? y[iY - 1].toB - y[iY - 1].toA : 0)), toB = fromB\n        let deleted = Span.none, inserted = Span.none\n\n        // Used to prevent appending ins/del range for the same Change twice\n        let enteredX = false, enteredY = false\n\n        // Need to have an inner loop since any number of further\n        // ranges might be touching this group\n        for (;;) {\n          let nextX = !curX ? 2e8 : pos >= curX.fromB ? curX.toB : curX.fromB\n          let nextY = !curY ? 2e8 : pos >= curY.fromA ? curY.toA : curY.fromA\n          let next = Math.min(nextX, nextY)\n          let inX = curX && pos >= curX.fromB, inY = curY && pos >= curY.fromA\n          if (!inX && !inY) break\n          if (inX && pos == curX.fromB && !enteredX) {\n            deleted = Span.join(deleted, curX.deleted, combine)\n            toA += curX.lenA\n            enteredX = true\n          }\n          if (inX && !inY) {\n            inserted = Span.join(inserted, Span.slice(curX.inserted, pos - curX.fromB, next - curX.fromB), combine)\n            toB += next - pos\n          }\n          if (inY && pos == curY.fromA && !enteredY) {\n            inserted = Span.join(inserted, curY.inserted, combine)\n            toB += curY.lenB\n            enteredY = true\n          }\n          if (inY && !inX) {\n            deleted = Span.join(deleted, Span.slice(curY.deleted, pos - curY.fromA, next - curY.fromA), combine)\n            toA += next - pos\n          }\n\n          if (inX && next == curX.toB) {\n            // @ts-ignore\n            curX = iX++ == x.length ? null : x[iX]\n            enteredX = false\n          }\n          if (inY && next == curY.toA) {\n            // @ts-ignore\n            curY = iY++ == y.length ? null : y[iY]\n            enteredY = false\n          }\n          pos = next\n        }\n        if (fromA < toA || fromB < toB)\n          result.push(new Change(fromA, toA, fromB, toB, deleted, inserted))\n      }\n    }\n  }\n}","/* eslint-disable */\n\nimport {computeDiff} from \"./diff\"\nimport {Change} from \"./change\"\nimport {Span} from \"./span\"\n\nimport { Node as PMNode } from \"prosemirror-model\"\nimport { AddMarkStep, RemoveMarkStep, ReplaceAroundStep, ReplaceStep, Step, StepMap } from \"prosemirror-transform\"\n\ninterface ChangeSetConfig {\n  doc: PMNode\n  combine: (data1: any, data2: any) => null | any\n}\n\n// ::- A change set tracks the changes to a document from a given\n// point in the past. It condenses a number of step maps down to a\n// flat sequence of replacements, and simplifies replacments that\n// partially undo themselves by comparing their content.\nexport class ChangeSet {\n\n  config: ChangeSetConfig\n  changes: Change[]\n\n  constructor(config: ChangeSetConfig, changes: Change[]) {\n    this.config = config\n    // :: [Change] Replaced regions.\n    this.changes = changes\n  }\n\n  addSteps2(newDoc: PMNode, steps: Step[], data?: any | any[]) {\n    let stepChanges: Change[] = []\n    // Add spans for new steps.\n    let off = 0\n    for (let i = 0; i < steps.length; i++) {\n      const step = steps[i]\n      let d = Array.isArray(data) ? data[i] : data\n\n      if (step instanceof ReplaceStep) {\n        console.log('replace step', step)\n        // @ts-ignore\n        const { from, to, slice } = step\n        const fromA = from\n        const toA = to\n        const fromB = from\n        const toB = from + slice.size\n        stepChanges.push(new Change(fromA + off, toA + off, fromB, toB,\n            fromA == toA ? Span.none : [new Span(toA - fromA, d)],\n            fromB == toB ? Span.none : [new Span(toB - fromB, d)]))\n        off = (toB - fromB) - (toA - fromA)\n        console.log('new change', stepChanges[stepChanges.length - 1])\n      } else if (step instanceof ReplaceAroundStep) {\n        console.log('replace around step', step)\n      } else if (step instanceof AddMarkStep) {\n        console.log('add mark step', step)\n        // @ts-ignore\n        const { from, to, mark } = step\n        const fromA = from\n        const toA = from\n        const fromB = from\n        const toB = to\n        stepChanges.push(new Change(fromA + off, toA + off, fromB, toB,\n            fromA == toA ? Span.none : [new Span(toA - fromA, d)],\n            fromB == toB ? Span.none : [new Span(toB - fromB, d)]))\n        off = (toB - fromB) - (toA - fromA)\n        console.log('new change', stepChanges[stepChanges.length - 1])\n\n      } else if (step instanceof RemoveMarkStep) {\n        console.log('remove mark step', step)\n        // @ts-ignore\n        const { from, to, mark } = step\n        const fromA = from\n        const toA = to\n        const fromB = from\n        const toB = from\n        stepChanges.push(new Change(fromA + off, toA + off, fromB, toB,\n            fromA == toA ? Span.none : [new Span(toA - fromA, d)],\n            fromB == toB ? Span.none : [new Span(toB - fromB, d)]))\n        off = (toB - fromB) - (toA - fromA)\n        console.log('new change', stepChanges[stepChanges.length - 1])\n  \n      } else {\n        console.error('Unknown step type! Change not tracked and possibly current changes have become inconsistent', step)\n      }\n\n    }\n    if (stepChanges.length == 0) return this\n\n    let newChanges = mergeAll(stepChanges, this.config.combine)\n    let changes = Change.merge(this.changes, newChanges, this.config.combine)\n\n    // Minimize changes when possible\n    for (let i = 0; i < changes.length; i++) {\n      let change = changes[i]\n      if (change.fromA == change.toA || change.fromB == change.toB ||\n          // Only look at changes that touch newly added changed ranges\n          !newChanges.some(r => r.toB > change.fromB && r.fromB < change.toB)) continue\n      let diff = computeDiff(this.config.doc.content, newDoc.content, change)\n\n      // Fast path: If they are completely different, don't do anything\n      if (diff.length == 1 && diff[0].fromB == 0 && diff[0].toB == change.toB - change.fromB)\n        continue\n\n      if (diff.length == 1) {\n        changes[i] = diff[0]\n      } else {\n        changes.splice(i, 1, ...diff)\n        i += diff.length - 1\n      }\n    }\n\n    return new ChangeSet(this.config, changes)\n  }\n\n  // :: (Node, [StepMap], union<[any], any>) → ChangeSet\n  // Computes a new changeset by adding the given step maps and\n  // metadata (either as an array, per-map, or as a single value to be\n  // associated with all maps) to the current set. Will not mutate the\n  // old set.\n  //\n  // Note that due to simplification that happens after each add,\n  // incrementally adding steps might create a different final set\n  // than adding all those changes at once, since different document\n  // tokens might be matched during simplification depending on the\n  // boundaries of the current changed ranges.\n  addSteps(newDoc: PMNode, steps: Step[], data?: any | any[]) {\n    // This works by inspecting the position maps for the changes,\n    // which indicate what parts of the document were replaced by new\n    // content, and the size of that new content. It uses these to\n    // build up Change objects.\n    //\n    // These change objects are put in sets and merged together using\n    // Change.merge, giving us the changes created by the new steps.\n    // Those changes can then be merged with the existing set of\n    // changes.\n    //\n    // For each change that was touched by the new steps, we recompute\n    // a diff to try to minimize the change by dropping matching\n    // pieces of the old and new document from the change.\n\n    let stepChanges: Change[] = []\n    // Add spans for new steps.\n    for (let i = 0; i < steps.length; i++) {\n      let d = Array.isArray(data) ? data[i] : data\n      let off = 0\n      let insideReplaceAroundStep = false\n      steps[i].getMap().forEach((fromA: number, toA: number, fromB: number, toB: number) => {\n        console.log(`changed ${fromA} ${toA} ${fromB} ${toB}`)\n        if (steps[i] instanceof ReplaceAroundStep && !insideReplaceAroundStep) {\n          insideReplaceAroundStep = true\n          d = { ...d, blockChange: 'start' }\n        } else if (steps[i] instanceof ReplaceAroundStep && insideReplaceAroundStep) {\n          insideReplaceAroundStep = false\n          d = { ...d, blockChange: 'end' }\n        }\n        stepChanges.push(new Change(fromA + off, toA + off, fromB, toB,\n                                    fromA == toA ? Span.none : [new Span(toA - fromA, d)],\n                                    fromB == toB ? Span.none : [new Span(toB - fromB, d)]))\n\n        off = (toB - fromB) - (toA - fromA)\n      })\n    }\n    if (stepChanges.length == 0) return this\n\n    let newChanges = mergeAll(stepChanges, this.config.combine)\n    let changes = Change.merge(this.changes, newChanges, this.config.combine)\n\n    // Minimize changes when possible\n    for (let i = 0; i < changes.length; i++) {\n      let change = changes[i]\n      if (change.fromA == change.toA || change.fromB == change.toB ||\n          // Only look at changes that touch newly added changed ranges\n          !newChanges.some(r => r.toB > change.fromB && r.fromB < change.toB)) continue\n      let diff = computeDiff(this.config.doc.content, newDoc.content, change)\n\n      // Fast path: If they are completely different, don't do anything\n      if (diff.length == 1 && diff[0].fromB == 0 && diff[0].toB == change.toB - change.fromB)\n        continue\n\n      if (diff.length == 1) {\n        changes[i] = diff[0]\n      } else {\n        changes.splice(i, 1, ...diff)\n        i += diff.length - 1\n      }\n    }\n\n    return new ChangeSet(this.config, changes)\n  }\n\n  // :: Node\n  // The starting document of the change set.\n  get startDoc() { return this.config.doc }\n\n  // :: (f: (range: Change) → any) → ChangeSet\n  // Map the span's data values in the given set through a function\n  // and construct a new set with the resulting data.\n  map(f: (range: Change) => any) {\n    return new ChangeSet(this.config, this.changes.map(change => {\n      let result = f(change)\n      return result === change ? change :\n        new Change(change.fromA, change.toA, change.fromB, change.toB, change.deleted, change.inserted)\n    }))\n  }\n\n  // :: (ChangeSet, ?[StepMap]) → ?{from: number, to: number}\n  // Compare two changesets and return the range in which they are\n  // changed, if any. If the document changed between the maps, pass\n  // the maps for the steps that changed it as second argument, and\n  // make sure the method is called on the old set and passed the new\n  // set. The returned positions will be in new document coordinates.\n  changedRange(b: ChangeSet, maps?: StepMap[]) {\n    if (b == this) return null\n    let touched = maps && touchedRange(maps)\n    let moved = touched ? (touched.toB - touched.fromB) - (touched.toA - touched.fromA) : 0\n    function map(p: number) {\n      return !touched || p <= touched.fromA ? p : p + moved\n    }\n\n    let from = touched ? touched.fromB : 2e8, to = touched ? touched.toB : -2e8\n    function add(start: number, end = start) {\n      from = Math.min(start, from); to = Math.max(end, to)\n    }\n\n    let rA = this.changes, rB = b.changes\n    for (let iA = 0, iB = 0; iA < rA.length && iB < rB.length;) {\n      let rangeA = rA[iA], rangeB = rB[iB]\n      if (rangeA && rangeB && sameRanges(rangeA, rangeB, map)) { iA++; iB++ }\n      else if (rangeB && (!rangeA || map(rangeA.fromB) >= rangeB.fromB)) { add(rangeB.fromB, rangeB.toB); iB++ }\n      else { add(map(rangeA.fromB), map(rangeA.toB)); iA++ }\n    }\n\n    return from <= to ? {from, to} : null\n  }\n\n  // :: (Node, ?(a: any, b: any) → any) → ChangeSet\n  // Create a changeset with the given base object and configuration.\n  // The `combine` function is used to compare and combine metadata—it\n  // should return null when metadata isn't compatible, and a combined\n  // version for a merged range when it is.\n  static create(doc: PMNode, combine = (a: any, b: any): any => a === b ? a : null) {\n    return new ChangeSet({combine, doc}, [])\n  }\n}\n\n// Exported for testing\n// @ts-ignore\nChangeSet.computeDiff = computeDiff\n\n// : ([[Change]], (any, any) → any, number, number) → [Change]\n// Divide-and-conquer approach to merging a series of ranges.\nfunction mergeAll(\n  ranges: Change[],\n  combine: (data1: any, data2: any) => null | any,\n  start = 0,\n  end = ranges.length\n) : Change[] {\n  if (end == start + 1) return [ranges[start]]\n  let mid = (start + end) >> 1\n  return Change.merge(mergeAll(ranges, combine, start, mid),\n                      mergeAll(ranges, combine, mid, end), combine)\n}\n\nfunction endRange(maps: StepMap[]) {\n  let from = 2e8, to = -2e8\n  for (let i = 0; i < maps.length; i++) {\n    let map = maps[i]\n    if (from != 2e8) {\n      from = map.map(from, -1)\n      to = map.map(to, 1)\n    }\n    map.forEach((_s, _e, start, end) => {\n      from = Math.min(from, start)\n      to = Math.max(to, end)\n    })\n  }\n  return from == 2e8 ? null : {from, to}\n}\n\nfunction touchedRange(maps: StepMap[]) {\n  let b = endRange(maps)\n  if (!b) return null\n  let a = endRange(maps.map(m => m.invert()).reverse())\n  if (!a) throw Error('endRange was null!')\n  return {fromA: a.from, toA: a.to, fromB: b.from, toB: b.to}\n}\n\nfunction sameRanges(a: Change, b: Change, map: (pos: number) => number) {\n  return map(a.fromB) == b.fromB && map(a.toB) == b.toB &&\n    sameSpans(a.deleted, b.deleted) && sameSpans(a.inserted, b.inserted)\n}\n\nfunction sameSpans(a: Span[], b: Span[]) {\n  if (a.length != b.length) return false\n  for (let i = 0; i < a.length; i++)\n    if (a[i].length != b[i].length || a[i].data !== b[i].data) return false\n  return true\n}","/* eslint-disable */\n\nimport { Fragment, Node as PMNode } from \"prosemirror-model\"\nimport {Change} from \"./change\"\nimport {Span} from \"./span\"\n\nlet letter: RegExp | undefined\n// If the runtime support unicode properties in regexps, that's a good\n// source of info on whether something is a letter.\ntry { letter = new RegExp(\"[\\\\p{Alphabetic}_]\", \"u\") } catch(_) {}\n\n// Otherwise, we see if the character changes when upper/lowercased,\n// or if it is part of these common single-case scripts.\nconst nonASCIISingleCaseWordChar = /[\\u00df\\u0587\\u0590-\\u05f4\\u0600-\\u06ff\\u3040-\\u309f\\u30a0-\\u30ff\\u3400-\\u4db5\\u4e00-\\u9fcc\\uac00-\\ud7af]/\n\nfunction isLetter(code: number) {\n  if (code < 128)\n    return code >= 48 && code <= 57 || code >= 65 && code <= 90 || code >= 79 && code <= 122\n  let ch = String.fromCharCode(code)\n  if (letter) return letter.test(ch)\n  return ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch)\n}\n\n// Convert a range of document into a string, so that we can easily\n// access characters at a given position. Treat non-text tokens as\n// spaces so that they aren't considered part of a word.\nfunction getText(frag: Fragment, start: number, end: number) {\n  let out = \"\"\n  function convert(frag: Fragment, start: number, end: number) {\n    for (let i = 0, off = 0; i < frag.childCount; i++) {\n      let child = frag.child(i), endOff = off + child.nodeSize\n      let from = Math.max(off, start), to = Math.min(endOff, end)\n      if (from < to) {\n        if (child.isText && child.text) {\n          out += child.text.slice(Math.max(0, start - off), Math.min(child.text.length, end - off))\n        } else if (child.isLeaf) {\n          out += \" \"\n        } else {\n          if (from == off) out += \" \"\n          convert(child.content, Math.max(0, from - off - 1), Math.min(child.content.size, end - off))\n          if (to == endOff) out += \" \"\n        }\n      }\n      off = endOff\n    }\n  }\n  convert(frag, start, end)\n  return out\n}\n\n// The distance changes have to be apart for us to not consider them\n// candidates for merging.\nconst MAX_SIMPLIFY_DISTANCE = 30\n\n// :: ([Change], Node) → [Change]\n// Simplifies a set of changes for presentation. This makes the\n// assumption that having both insertions and deletions within a word\n// is confusing, and, when such changes occur without a word boundary\n// between them, they should be expanded to cover the entire set of\n// words (in the new document) they touch. An exception is made for\n// single-character replacements.\nexport function simplifyChanges(changes: Change[], doc: PMNode) {\n  let result: Change[] = []\n  for (let i = 0; i < changes.length; i++) {\n    let end = changes[i].toB, start = i\n    while (i < changes.length - 1 && changes[i + 1].fromB <= end + MAX_SIMPLIFY_DISTANCE)\n      end = changes[++i].toB\n    simplifyAdjacentChanges(changes, start, i + 1, doc, result)\n  }\n  return result\n}\n\nfunction simplifyAdjacentChanges(changes: Change[], from: number, to: number, doc: PMNode, target: Change[]) {\n  let start = Math.max(0, changes[from].fromB - MAX_SIMPLIFY_DISTANCE)\n  let end = Math.min(doc.content.size, changes[to - 1].toB + MAX_SIMPLIFY_DISTANCE)\n  let text = getText(doc.content, start, end)\n\n  for (let i = from; i < to; i++) {\n    let startI = i, last = changes[i], deleted = last.lenA, inserted = last.lenB\n    while (i < to - 1) {\n      let next = changes[i + 1], boundary = false\n      let prevLetter = last.toB == end ? false : isLetter(text.charCodeAt(last.toB - 1 - start))\n      for (let pos = last.toB; !boundary && pos < next.fromB; pos++) {\n        let nextLetter = pos == end ? false : isLetter(text.charCodeAt(pos - start))\n        if ((!prevLetter || !nextLetter) && pos != changes[startI].fromB) boundary = true\n        prevLetter = nextLetter\n      }\n      if (boundary) break\n      deleted += next.lenA; inserted += next.lenB\n      last = next\n      i++\n    }\n\n    if (inserted > 0 && deleted > 0 && !(inserted == 1 && deleted == 1)) {\n      let from = changes[startI].fromB, to = changes[i].toB\n      if (from < end && isLetter(text.charCodeAt(from - start)))\n        while (from > start && isLetter(text.charCodeAt(from - 1 - start))) from--\n      if (to > start && isLetter(text.charCodeAt(to - 1 - start)))\n        while (to < end && isLetter(text.charCodeAt(to - start))) to++\n      let joined = fillChange(changes.slice(startI, i + 1), from, to)\n      let last = target.length ? target[target.length - 1] : null\n      if (last && last.toA == joined.fromA)\n        target[target.length - 1] = new Change(last.fromA, joined.toA, last.fromB, joined.toB,\n                                               last.deleted.concat(joined.deleted), last.inserted.concat(joined.inserted))\n      else\n        target.push(joined)\n    } else {\n      for (let j = startI; j <= i; j++) target.push(changes[j])\n    }\n  }\n  return changes\n}\n\nfunction combine(data1: any, data2: any) { return data1 === data2 ? data1 : null }\n\nfunction fillChange(changes: Change[], fromB: number, toB: number) {\n  let fromA = changes[0].fromA - (changes[0].fromB - fromB)\n  let last = changes[changes.length - 1]\n  let toA = last.toA + (toB - last.toB)\n  let deleted = Span.none, inserted = Span.none\n  let delData = (changes[0].deleted.length ? changes[0].deleted : changes[0].inserted)[0].data\n  let insData = (changes[0].inserted.length ? changes[0].inserted : changes[0].deleted)[0].data\n  for (let posA = fromA, posB = fromB, i = 0;; i++) {\n    let next = i == changes.length ? null : changes[i]\n    let endA = next ? next.fromA : toA, endB = next ? next.fromB : toB\n    if (endA > posA) deleted = Span.join(deleted, [new Span(endA - posA, delData)], combine)\n    if (endB > posB) inserted = Span.join(inserted, [new Span(endB - posB, insData)], combine)\n    if (!next) break\n    deleted = Span.join(deleted, next.deleted, combine)\n    inserted = Span.join(inserted, next.inserted, combine)\n    if (deleted.length) delData = deleted[deleted.length - 1].data\n    if (inserted.length) insData = inserted[inserted.length - 1].data\n    posA = next.toA; posB = next.toB\n  }\n  return new Change(fromA, toA, fromB, toB, deleted, inserted)\n}","import { EditorState, Transaction } from 'prosemirror-state'\nimport { Node as PMNode, ResolvedPos } from 'prosemirror-model'\nimport { Change, ChangeSet } from 'custom-changeset'\nimport { findWrapping, liftTarget } from 'prosemirror-transform'\n\nfunction updateChangesWithBlockChange(acceptedChange: Change, changes: Change[], changeIndex: number) : Change[] {\n  const beforeChanges = changes.slice(0, changeIndex)\n  let offset = acceptedChange.lenB - acceptedChange.lenA\n  let toBlockChangeEnd = 0\n  const afterChanges = changes.slice(changeIndex + 1).map(c => {\n    if (c.isBlockChangeStart) {\n      toBlockChangeEnd += 1\n    } else if (c.isBlockChangeEnd && toBlockChangeEnd !== 0) {\n      toBlockChangeEnd -= 1\n    } else if (c.isBlockChangeEnd) {\n      offset += acceptedChange.lenB - acceptedChange.lenA\n      return null\n    }\n    return new Change(c.fromA + offset, c.toA + offset, c.fromB, c.toB, c.deleted, c.inserted)\n  }).filter(c => c !== null) as Change[]\n  return [...beforeChanges, ...afterChanges]\n}\n\nfunction updateChanges(acceptedChange: Change, changes: Change[], changeIndex: number) : Change[] {\n  // The changes before the accepted change stay as previously, only the changes afterwards must be updated\n  // to account for the changed startDoc\n  const beforeChanges = changes.slice(0, changeIndex)\n  const afterChanges = changes.slice(changeIndex + 1).map(c => {\n    const fromA = c.fromA - acceptedChange.lenA + acceptedChange.lenB\n    const toA = c.toA - acceptedChange.lenA + acceptedChange.lenB\n    return new Change(fromA, toA, c.fromB, c.toB, c.deleted, c.inserted)\n  })\n  return [...beforeChanges, ...afterChanges]\n}\n\nfunction wrapWithNode(pos: number, wrapperNode: PMNode, doc: PMNode, tr: Transaction) {\n  const startPos = doc.resolve(pos)\n  const node = doc.nodeAt(pos)\n  if (!node) return undefined\n  const range = startPos.blockRange(doc.resolve(startPos.pos + node.nodeSize))\n  const wrapping = range && findWrapping(range, wrapperNode.type, wrapperNode.attrs)\n  if (range && wrapping) {\n    return tr.wrap(range, wrapping).scrollIntoView()\n  }\n  return undefined\n}\n\nfunction liftNode(pos: number, doc: PMNode, tr: Transaction) {\n  const startPos = doc.resolve(pos)\n  const node = doc.nodeAt(pos)\n  if (!node) return undefined\n  const range = startPos.blockRange(doc.resolve(startPos.pos + node.nodeSize))\n  if (range) {\n    const targetDepth = Number(liftTarget(range))\n    if (!Number.isNaN(targetDepth)) {\n      return tr.lift(range, targetDepth)\n    }\n  }\n  return undefined\n}\n\nexport function rejectChange(\n  changeIndex: number,\n  changeSet: ChangeSet,\n  startState: EditorState,\n  currentState: EditorState\n) {\n  const change = changeSet.changes[changeIndex]\n  const wasBlockChange = change.isBlockChangeStart\n  const insertOnly = change.lenA === 0\n  const deleteOnly = change.lenB === 0\n  let tr\n  if (wasBlockChange && insertOnly) {\n    tr = liftNode(change.fromB + 1, currentState.doc, currentState.tr)\n  } else if (wasBlockChange && deleteOnly) {\n    const node = startState.doc.nodeAt(change.fromA)\n    if (!node) return undefined\n    tr = wrapWithNode(change.fromB, node, currentState.doc, currentState.tr)\n  } else if (wasBlockChange) {\n    throw Error('Unhandled mixed blockChange + text change')\n  } else {\n    const slice = startState.doc.slice(change.fromA, change.toA)\n    tr = currentState.tr.replaceWith(change.fromB, change.toB, slice.content)\n  }\n  return tr\n}\n\nexport function acceptChange(\n  changeIndex: number,\n  oldChangeSet: ChangeSet,\n  startState: EditorState,\n  currentState: EditorState\n) {\n  const change = oldChangeSet.changes[changeIndex]\n  const wasBlockChange = change.isBlockChangeStart\n  const insertOnly = change.lenA === 0\n  let changes\n  if (wasBlockChange && change.lenA > 0 && change.lenB > 0 ) {\n    throw Error('Unhandled mixed blockChange + text change')\n  } else if (wasBlockChange) {\n    let tr\n    if (insertOnly) {\n      const node = currentState.doc.nodeAt(change.fromB)\n      tr = wrapWithNode(change.fromA, node!, startState.doc, startState.tr)\n    } else {\n      tr = liftNode(change.fromA + 1, startState.doc, startState.tr)\n    }\n    if (!tr) return oldChangeSet\n    startState = startState.apply(tr)\n    changes = updateChangesWithBlockChange(change, oldChangeSet.changes, changeIndex)\n  } else {\n    const slice = currentState.doc.slice(change.fromB, change.toB)\n    startState = startState.apply(startState.tr.replaceWith(change.fromA, change.toA, slice.content))\n    changes = updateChanges(change, oldChangeSet.changes, changeIndex)\n  }\n  return new ChangeSet({ ...oldChangeSet.config, doc: startState.doc }, changes)\n}","import React, { useState } from 'react'\nimport styled from 'styled-components'\nimport { render, unmountComponentAtNode } from 'react-dom'\nimport { createPopper } from '@popperjs/core'\n\nimport { FiCheck, FiX } from 'react-icons/fi'\n\nimport { Comment, TrackedChange } from './types'\n\nexport function renderCommentPopUp(target: HTMLElement, container: HTMLElement, props: Props) {\n  render(<CommentPopUp {...props}/>, container)\n  const popper = createPopper(target, container, {\n    placement: 'bottom',\n  })\n  return {\n    destroy() {\n      unmountComponentAtNode(container)\n      popper.destroy()\n    }\n  }\n}\n\ninterface Props {\n  change: TrackedChange\n  comments: Comment[]\n  onClose: () => void\n  onAccept: () => void\n  onReject: () => void\n  onSubmitReply: (text: string) => Promise<void>\n}\n\nfunction CommentPopUp(props: Props) {\n  const { change, comments, onClose, onAccept, onReject, onSubmitReply } = props\n  const [reply, setReply] = useState('')\n  function handleKeyPress(e: React.KeyboardEvent) {\n\n  }\n  return (\n    <Container>\n      <CornerX>\n        <CloseIconBtn onClick={() => onClose()}><FiX size={14}/></CloseIconBtn>\n      </CornerX>\n      <List>\n        <Item>\n          <UserInfo>\n            <Name>{change.author.name}</Name>\n            <Time>{change.timeStr}</Time>\n          </UserInfo>\n          { change.inserted && <div>inserted: \"{change.inserted}\"</div>}\n          { change.deleted && <div>deleted: \"{change.deleted}\"</div>}\n        </Item>\n        { comments.map(c =>          \n        <Item key={c.id}>\n          <UserInfo>\n            <Name>{c.user.name}</Name>\n            <Time>{c.timeStr}</Time>\n          </UserInfo>\n          <div>\n            {c.text}\n          </div>\n        </Item>\n        )}\n      </List>\n      <ReplyInput placeholder=\"Reply...\" value={reply} onChange={e => setReply(e.target.value)}/>\n      <Buttons>\n        <AcceptBtn className=\"accept\" onClick={() => onAccept()}>\n          <FiCheck size={14}/>\n        </AcceptBtn>\n        <AcceptBtn className=\"reject\" onClick={() => onReject()}>\n          <FiX size={14}/>\n        </AcceptBtn>\n      </Buttons>\n    </Container>\n  )\n}\n\nconst Container = styled.div`\n  background: #333;\n  color: white;\n  padding: 1rem;\n  position: relative;\n  font-size: 13px;\n  border-radius: 4px;\n`\nconst List = styled.ul`\n  list-style: none;\n  margin: 0;\n  padding: 0;\n`\nconst Item = styled.li`\n  & > div {\n    display: flex;\n    margin-bottom: 0.25rem;\n  }\n`\nconst CornerX = styled.div`\n  position: absolute;\n  right: -6px;\n  top: -6px;\n`\nconst CloseIconBtn = styled.button`\n  align-items: center;\n  background: #333;\n  border: 0;\n  border-radius: 100%;\n  color: white;\n  cursor: pointer;\n  display: flex;\n  justify-content: center;\n  padding: 0.25rem;\n`\nconst UserInfo = styled.div`\n  display: flex;\n`\nconst Name = styled.div`\n  margin-right: 1rem;\n`\nconst Time = styled.time``\nconst ReplyInput = styled.input`\n  background: #e4e4e4;\n  border: 0;\n  border-radius: 2px;\n  color: #222;\n  height: 1rem;\n  margin-top: 0.5rem;\n  padding: 0.75rem 0.5rem;\n  width: 100%;\n`\nconst Buttons = styled.div`\n  display: flex;\n  margin-top: 1rem;\n  & > button + button {\n    margin-left: 1rem;\n  }\n`\nconst AcceptBtn = styled.button`\n  align-items: center;\n  border: 0;\n  border-radius: 2px;\n  color: #222;\n  cursor: pointer;\n  display: flex;\n  padding: 0.25rem 0.75rem;\n  justify-content: center;\n  &.accept {\n    background: #16d816;\n  }\n  &.reject {\n    background: #ff3c3c;\n  }\n`\n","import { EditorView, Decoration } from 'prosemirror-view'\nimport { EditorState } from 'prosemirror-state'\nimport { DOMSerializer } from 'prosemirror-model'\nimport { ChangeSet } from 'custom-changeset'\n\nconst deletedWidget = (html: DocumentFragment, attrs: {[key: string]: string}) => (view: EditorView, getPos: () => number) => {\n  const element = document.createElement('span')\n  element.appendChild(html)\n  Object.keys(attrs).forEach((key) => {\n    element.setAttribute(key, attrs[key])\n  })\n  return element\n}\n\nexport function renderDecorations(\n  changeSet: ChangeSet,\n  userColors: Map<string, [string, string]>,\n  domSerializer: DOMSerializer,\n  startState: EditorState\n) {\n  const decorations: Decoration[] = []\n  let allDeletionsLength = 0\n  let allInsertsLength = 0\n\n  changeSet.changes.forEach((change, index) => {\n    let insertFrom = change.fromB\n    const { inserted, deleted } = change\n    const changeType = change.deleted.length > 0 ? change.inserted.length > 0 ? 'insert+delete' : 'delete' : 'insert'\n    inserted.forEach((span) => {\n      // @ts-ignore\n      const spanLength = span.length\n      const colors = userColors.get(span.data.userID)\n      const style = `background: ${colors ? colors[0] : ''};`\n      decorations.push(Decoration.inline(insertFrom, change.toB, {\n        style,\n        'data-change-type': changeType,\n        'data-change-index': index.toString(),\n      }))\n      insertFrom += spanLength\n      allInsertsLength += spanLength\n    })\n\n    let deletionsLength = 0\n    deleted.forEach((span) => {\n      // @ts-ignore\n      const spanLength = span.length\n      const start = change.fromA + deletionsLength\n      const content = startState.doc.slice(start, start + spanLength)\n      const html = domSerializer.serializeFragment(content.content)\n      const colors = userColors.get(span.data.userID)\n      const style = `background: ${colors ? colors[1] : ''};`\n      const attrs = {\n        style,\n        'data-change-type': changeType,\n        'data-change-index': index.toString(),\n      }\n      decorations.push(\n        Decoration.widget(start + allDeletionsLength + allInsertsLength, deletedWidget(html, attrs), {\n          side: 0,\n          marks: [startState.schema.marks.strikethrough.create()],\n        })\n      )\n      allDeletionsLength -= spanLength\n      deletionsLength += spanLength\n    })\n  })\n  return decorations\n}","import { DecorationSet } from 'prosemirror-view'\nimport { EditorState, Plugin, PluginKey } from 'prosemirror-state'\nimport { DOMSerializer } from 'prosemirror-model'\n// import { Change, ChangeSet } from 'prosemirror-changeset'\nimport { Change, ChangeSet } from 'custom-changeset'\n\nimport { acceptChange, rejectChange } from './acceptChange' \nimport { renderCommentPopUp } from './CommentPopUp'\nimport { renderDecorations } from './renderDecorations'\n\nimport { ExampleSchema } from '../schema'\nimport { TrackedChangeType } from './types'\n\nexport interface TrackChangesState {\n  startState: EditorState\n  changeSet: ChangeSet\n  decorationSet: DecorationSet<ExampleSchema>\n  userColors: Map<string, [string, string]>\n  userID: string\n}\n\nexport const trackChangesPluginKey = new PluginKey<TrackChangesState, ExampleSchema>('track-changes')\n\nconst colorScheme: [string, string][] = [\n  ['greenyellow', '#ffa4a4'],\n  ['#10c727', '#ff0707'],\n  ['#7adcb8', '#f93aa2']\n]\n\nexport const trackChangesPlugin = () => {\n\n  const popUpElement = document.createElement('div')\n  popUpElement.id = 'track-changes-comment-pop-up'\n  document.querySelector('body')?.appendChild(popUpElement)\n  let renderedPopper: {\n    destroy: () => void\n  } | undefined\n  let domSerializer: DOMSerializer<ExampleSchema>\n\n  return new Plugin<TrackChangesState, ExampleSchema>({\n    key: trackChangesPluginKey,\n    state: {\n      init(config, state) {\n        domSerializer = state.schema.cached?.domSerializer || DOMSerializer.fromSchema(state.schema)\n        return {\n          startState: state,\n          changeSet: ChangeSet.create(state.doc),\n          decorationSet: DecorationSet.empty,\n          userColors: new Map(),\n          userID: '1',\n        }\n      },\n\n      apply(tr, value, oldState, newState) {\n        if (tr.getMeta('set-userID')) {\n          return { ...value, userID: tr.getMeta('set-userID') }\n        }\n        const { changeSet: oldChangeSet, startState: oldStartState, userColors, userID } = value\n        let changeSet: ChangeSet\n        let startState = oldStartState\n        const acceptedChangeIndex = Number(tr.getMeta('accept-change'))\n        if (!Number.isNaN(acceptedChangeIndex)) {\n          changeSet = acceptChange(acceptedChangeIndex, oldChangeSet, startState, newState)\n        } else {\n          changeSet = oldChangeSet.addSteps(tr.doc, tr.steps, { userID })\n          // changeSet = oldChangeSet.addSteps2(tr.doc, tr.steps, { userID })\n        }\n\n        if (!userColors.has(userID)) {\n          userColors.set(userID, colorScheme[userColors.size])\n        }\n        const decorations = renderDecorations(changeSet, userColors, domSerializer, startState)\n        return {\n          startState,\n          changeSet,\n          decorationSet: DecorationSet.create(tr.doc, decorations),\n          userColors,\n          userID,\n        }\n      },\n    },\n    appendTransaction(trs, _oldState, newState) {\n      const rejectedChangeTr = trs.find(tr => !Number.isNaN(tr.getMeta('reject-change')))\n      const rejectedChangeIndex = Number(rejectedChangeTr?.getMeta('reject-change'))\n      const trackState = trackChangesPluginKey.getState(newState)\n      if (!Number.isNaN(rejectedChangeIndex) && trackState) {\n        const { changeSet, startState } = trackState\n        return rejectChange(rejectedChangeIndex, changeSet, startState, newState)\n      }\n      return null\n    },\n    props: {\n      decorations(state) {\n        return this.getState(state).decorationSet\n      },\n      handleClickOn(view, _pos, _node, _nodePos, event, _direct) {\n        const el = event.target ? event.target as HTMLElement : undefined\n        const dataChangeIndex = el?.getAttribute('data-change-index')\n        const dataChangeType = el?.getAttribute('data-change-type')\n\n        if (el && dataChangeIndex && dataChangeType) {\n          const changeSet = this.getState(view.state).changeSet\n          const changeIndex = Number(dataChangeIndex)\n          const change = changeSet.changes[changeIndex]\n          const changeType = dataChangeType as TrackedChangeType\n          const inserted = (changeType === 'insert' || changeType === 'insert+delete') ?\n            view.state.doc.textBetween(change.fromB, change.toB) : undefined\n          const deleted = (changeType === 'delete' || changeType === 'insert+delete') ?\n            changeSet.startDoc.textBetween(change.fromA, change.toA) : undefined\n\n          const props = {\n            change: {\n              type: changeType,\n              timeStr: '02-13-2019 11:20AM',\n              inserted,\n              deleted,\n              author: {\n                name: 'John Doe'\n              }\n            },\n            comments: [],\n            onClose: () => {\n              renderedPopper?.destroy()\n            },\n            onAccept: () => {\n              view.dispatch(view.state.tr.setMeta('accept-change', changeIndex))\n              renderedPopper?.destroy()\n            },\n            onReject: () => {\n              view.dispatch(view.state.tr.setMeta('reject-change', changeIndex))\n              renderedPopper?.destroy()\n            },\n            onSubmitReply: (text: string) => {\n              console.log('submitted', text)\n              return Promise.resolve()\n            }\n          }\n          renderedPopper = renderCommentPopUp(el, popUpElement, props)\n        }\n        return false\n      }\n    },\n  })\n}","import React from 'react'\nimport styled from 'styled-components'\n// import { Change } from 'prosemirror-changeset'\nimport { Change } from 'custom-changeset'\n\nimport { useEditorContext } from 'pm/EditorContext'\nimport { usePluginState } from './usePluginState'\n\nimport { TrackChangesState, trackChangesPluginKey } from 'pm/track-changes/track-changes-plugin'\n\ninterface IProps {\n  className?: string\n}\n\nexport function ChangesList(props: IProps) {\n  const { className } = props\n  const { viewProvider } = useEditorContext()\n  const trackChangesState = usePluginState<TrackChangesState>(trackChangesPluginKey)\n\n  function handleAcceptChange(idx: number) {\n    viewProvider.view.dispatch(viewProvider.view.state.tr.setMeta('accept-change', idx))\n  }\n  function handleRejectChange(idx: number) {\n    viewProvider.view.dispatch(viewProvider.view.state.tr.setMeta('reject-change', idx))\n  }\n  function changeTitle(c: Change) {\n    if (c.blockChange && c.inserted.length > 0) {\n      return 'Block insert'\n    } else if (c.blockChange && c.deleted.length > 0) {\n      return 'Block delete'\n    }\n    return c.deleted.length > 0 ? c.inserted.length > 0 ? 'Insertion + Deletion' : 'Deletion' : 'Insertion'\n  }\n  // const changes = trackChangesState?.changeSet.changes.filter((c: Change) => c.blockChange !== 'end') || []\n  const changes = trackChangesState?.changeSet.changes || []\n  return (\n    <List className={className}>\n      { changes.map((c: Change, i: number) =>\n      <CommitItem\n        key={i}\n      >\n        <TitleWrapper>\n          <h4>{ changeTitle(c) }</h4>\n          <Buttons>\n            <button onClick={() => handleAcceptChange(i)}>\n              Accept\n            </button>\n            <button onClick={() => handleRejectChange(i)}>\n              Reject\n            </button>\n          </Buttons>\n        </TitleWrapper>\n        <Ranges>\n          <span className=\"msg\">fromA: {c.fromA}</span>\n          <span className=\"msg\">toA: {c.toA}</span>\n          <span className=\"msg\">fromB: {c.fromB}</span>\n          <span className=\"msg\">toB: {c.toB}</span>\n        </Ranges>\n      </CommitItem>\n      )}\n    </List>\n  )\n}\n\nconst List = styled.ul`\n  display: flex;\n  flex-direction: column;\n  list-style: none;\n  padding: 0;\n  & > li + li {\n    margin-top: 1rem;\n  }\n`\nconst CommitItem = styled.li`\n`\nconst TitleWrapper = styled.div`\n  align-items: center;\n  display: flex;\n  justify-content: space-between;\n  & > h4 {\n    margin: 0;\n    margin-right: 1rem;\n  }\n`\nconst Buttons = styled.div`\n  display: flex;\n  margin: 0.25rem 0;\n  button + button {\n    margin-left: 0.5rem;\n  }\n`\nconst Ranges = styled.div`\n  align-items: center;\n  display: flex;\n  & > .msg {\n    margin-right: 1rem;\n  }\n`\n","import { createContext, useContext } from 'react'\n\nimport { TrackChangesStore } from './TrackChangesStore'\n\ninterface Context {\n  store: TrackChangesStore\n}\n\nexport const TrackChangesContext = createContext<Context>({} as Context)\n\nexport const useTrackChangesContext = () => useContext(TrackChangesContext)\n","import { Delta } from 'jsondiffpatch'\nimport { Node as PMNode } from 'prosemirror-model'\n\nimport { ChangeTreeNode } from '../change-tree/types'\n\nfunction createNode(\n  node: PMNode,\n  depth: number,\n  path: number[],\n  parent: string | null\n): ChangeTreeNode {\n  return {\n    id: Math.random().toString(),\n    node,\n    depth: depth + 1,\n    type: node.type.name,\n    changes: [],\n    path,\n    parent,\n    children: [],\n  }\n}\n\nfunction isDelete(val: { [key: string]: any }) {\n  return (\n    Array.isArray(val) &&\n    typeof val[0] === 'object' &&\n    val[1] === 0 &&\n    val[2] === 0\n  )\n}\n\nfunction isMove(val: { [key: string]: any }) {\n  return (\n    Array.isArray(val) &&\n    typeof val[0] === 'string' &&\n    typeof val[1] === 'number' &&\n    val[2] === 3\n  )\n}\n\nfunction isTextDiff(val: { [key: string]: any }) {\n  return (\n    Array.isArray(val) &&\n    typeof val[0] === 'string' &&\n    val[1] === 0 &&\n    val[2] === 2\n  )\n}\n\nfunction isInsert(val: { [key: string]: any }) {\n  return Array.isArray(val) && val.length === 1 && typeof val[0] === 'object'\n}\n\nfunction getArrayDeltaType(value: any) {\n  if (!Array.isArray(value)) {\n    return undefined\n  } else if (isDelete(value)) {\n    return 'delete'\n  } else if (isMove(value)) {\n    return 'move'\n  } else if (isTextDiff(value)) {\n    return 'text-diff'\n  } else if (isInsert(value)) {\n    return 'insert'\n  }\n  return 'unknown'\n}\n\nfunction getNode(node: PMNode, path: number[]): PMNode {\n  return path.length === 0 ? node : getNode(node.child(path[0]), path.slice(1))\n}\n\nexport function recurseDeltas(\n  delta: Delta,\n  pmNode: PMNode,\n  depth: number,\n  doc: PMNode,\n  originalDoc: PMNode,\n  path: number[],\n  parent: string | null,\n  treeMap: Map<ChangeTreeNode, ChangeTreeNode>\n) {\n  const treeNode = createNode(pmNode, depth, path, parent)\n  treeMap.set(treeNode, treeNode)\n\n  Object.entries(delta).forEach(([key, value]) => {\n    const wasArrayDelta = Array.isArray(value)\n    treeNode.changes.push({\n      msg: `${pmNode.type.name} ${key} changed`,\n      type: wasArrayDelta ? 'array-delta' : 'inner-change',\n      key,\n      value: wasArrayDelta ? value : undefined,\n    })\n  })\n\n  const children = []\n  for (const key in delta.content) {\n    if (key === '_t') {\n      continue\n    }\n    const wasMoveOrDelete = key.charAt(0) === '_'\n    const val = delta.content[key]\n    const index = wasMoveOrDelete ? parseInt(key.substr(1)) : parseInt(key)\n    const arrayDelta = getArrayDeltaType(val)\n    const childPath = path.concat(index)\n    const foundNode =\n      arrayDelta === 'delete'\n        ? getNode(originalDoc, childPath)\n        : getNode(doc, childPath)\n    const childTreeNode = recurseDeltas(\n      val,\n      foundNode,\n      depth + 1,\n      doc,\n      originalDoc,\n      childPath,\n      treeNode.id,\n      treeMap\n    )\n    childTreeNode.changes.push({\n      msg: `${foundNode.type.name} child node at ${index} changed`,\n      type: arrayDelta ?? 'child-change',\n      key,\n      value: arrayDelta ?? undefined,\n    })\n    children.push(childTreeNode)\n  }\n\n  treeNode.children = children\n  return treeNode\n}\n\nexport function print(tree: ChangeTreeNode) {\n  const recurse = (node: ChangeTreeNode): any => ({\n    ...node,\n    node: undefined,\n    children: node.children.map((n) => recurse(n)),\n  })\n  const pruned = recurse(tree)\n  console.log(JSON.stringify(pruned, null, 2))\n}\n","import { EditorView } from 'prosemirror-view'\nimport { EditorState } from 'prosemirror-state'\nimport { DiffPatcher } from 'jsondiffpatch'\n\nimport { trackChangesPluginKey } from 'pm/track-changes/track-changes-plugin'\nimport { print, recurseDeltas } from './recurseDeltas'\n\nexport class TrackChangesStore {\n  view: EditorView\n  startState: EditorState\n\n  constructor(view: EditorView) {\n    this.view = view\n    this.startState = view.state\n  }\n\n  diff() {\n    const trackChangesState = trackChangesPluginKey.getState(this.view.state)\n    if (!trackChangesState) {\n      return undefined\n    }\n    const state = this.view.state\n    const currentDoc = state.doc\n    const origDoc = trackChangesState.changeSet.startDoc\n    const diffPatcher = new DiffPatcher({\n      objectHash(node, index) {\n        return node?.attrs?.id || `$$index: ${index}`\n      },\n      arrays: { detectMove: true, includeValueOnMove: false },\n      textDiff: { minLength: 1 },\n    })\n    const diff = diffPatcher.diff(origDoc?.toJSON(), currentDoc.toJSON()) || {}\n    const map = new Map()\n    const changeTree = recurseDeltas(\n      diff,\n      currentDoc,\n      0,\n      currentDoc,\n      origDoc,\n      [],\n      null,\n      map\n    )\n    // this.emit('change-tree-updated', changeTree)\n    print(changeTree)\n    return changeTree\n  }\n}\n","import React from 'react'\nimport styled from 'styled-components'\n\ninterface Props {\n  onClick: () => void\n}\n\nexport function TrackChangesBtn(props: Props) {\n  const { onClick } = props\n  return (\n    <TrackChangesBtnWrapper onClick={onClick}>Diff</TrackChangesBtnWrapper>\n  )\n}\n\nconst TrackChangesBtnWrapper = styled.button`\n  position: fixed;\n  top: 16px;\n  right: 16px;\n  background: #32c20e;\n  border-radius: 4px;\n  box-shadow: 0 0 30px rgb(0 0 0 / 30%);\n  color: white;\n  cursor: pointer;\n  padding: 0.5rem 1rem;\n  -webkit-transition: opacity 0.3s;\n  transition: opacity 0.3s;\n  z-index: 99999;\n`\n","import React from 'react'\nimport styled from 'styled-components'\n\nimport { Change, ChangeTreeNode } from './types'\n\ninterface IProps {\n  className?: string\n  node: ChangeTreeNode\n}\n\nexport const ChangeNode = (props: IProps) => {\n  const { className = '', node } = props\n  function handleChangeClick(change: Change) {\n    console.log(change)\n  }\n  return (\n    <>\n      <Container className={className} depth={node.depth}>\n        <ChangesList>\n          {node.changes.map((c: Change, i: number) => (\n            <ChangeItem key={i}>\n              <span className=\"msg\">{c.msg}</span>\n              <span className=\"msg\">{c.type}</span>\n              <span className=\"msg\">{c.key}</span>\n              <span className=\"msg\">{c.value}</span>\n              <ShowBtn onClick={() => handleChangeClick(c)}>Show</ShowBtn>\n            </ChangeItem>\n          ))}\n        </ChangesList>\n      </Container>\n      {node.children.map((n) => (\n        <ChangeNode key={n.id} node={n} />\n      ))}\n    </>\n  )\n}\n\nconst Container = styled.li<{ depth: number }>`\n  padding-left: ${({ depth }) => depth * 8}px;\n`\nconst ChangesList = styled.ul`\n  display: flex;\n  flex-direction: column;\n  list-style: none;\n  padding: 0;\n  & > li + li {\n    margin-top: 0.5rem;\n  }\n`\nconst ChangeItem = styled.li`\n  align-items: center;\n  display: flex;\n  & > .date {\n    background: var(--color-primary-lighter);\n    border: 4px;\n    margin-right: 1rem;\n    padding: 0.1rem 0.25rem;\n  }\n  & > .msg {\n    margin-right: 1rem;\n  }\n`\nconst ShowBtn = styled.button<{ active?: boolean }>`\n  background: ${({ active }) => active && 'pink'};\n`\n","import React from 'react'\nimport styled from 'styled-components'\n\nimport { ChangeNode } from './ChangeNode'\nimport { ChangeTreeNode } from './types'\n\ninterface Props {\n  className?: string\n  changeTree: ChangeTreeNode | null\n}\n\nexport const ChangeSummary = (props: Props) => {\n  const { className = '', changeTree } = props\n  return (\n    <Container className={className}>\n      {changeTree && <ChangeNode node={changeTree} />}\n    </Container>\n  )\n}\n\nconst Container = styled.ul`\n  display: flex;\n  flex-direction: column;\n  font-size: 13px;\n  list-style: none;\n  margin: 0 0 1rem 0;\n  padding: 0;\n  & > li + li {\n    margin-top: 0.5rem;\n  }\n`\n","import React, { useState } from 'react'\nimport styled from 'styled-components'\n\nimport { ChangeSummary } from './change-tree/ChangeSummary'\nimport { ChangeTreeNode } from './change-tree/types'\nimport { useTrackChangesContext } from './state/TrackChangesContext'\n\ninterface Props {\n  onClose: () => void\n}\n\nexport function TrackChangesPanel(props: Props) {\n  const { onClose } = props\n  const [changeTree, setChangeTree] = useState<ChangeTreeNode | null>(null)\n  const { store } = useTrackChangesContext()\n\n  function handleClickDiff() {\n    const diff = store.diff()\n    if (diff) {\n      setChangeTree(diff)\n    }\n  }\n\n  return (\n    <Wrapper>\n      <Container>\n        <TopRow>\n          <button onClick={handleClickDiff}>Diff</button>\n          <button onClick={onClose}>Close</button>\n        </TopRow>\n        <ChangeSummary changeTree={changeTree} />\n      </Container>\n    </Wrapper>\n  )\n}\n\nconst Wrapper = styled.div`\n  position: fixed;\n  width: 0px;\n  height: 0px;\n  top: 0px;\n  left: 0px;\n  z-index: 99999999;\n`\nconst Container = styled.div`\n  background-color: #fff;\n  position: fixed;\n  z-index: 1;\n  box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 4px 0px;\n  overflow: scroll;\n  left: 50%;\n  top: 0;\n  width: 50%;\n  height: 100%;\n  transition: left 0.2s ease-out 0s, top 0.2s ease-out 0s,\n    width 0.2s ease-out 0s, height 0.2s ease-out 0s;\n`\nconst TopRow = styled.div`\n  display: flex;\n  padding: 0.5rem;\n  & > * + * {\n    margin-left: 1rem;\n  }\n`\n","import React, { useState } from 'react'\n\nimport { TrackChangesBtn } from './TrackChangesBtn'\nimport { TrackChangesPanel } from './TrackChangesPanel'\n\nexport function TrackChangesControls() {\n  const [active, setActive] = useState(false)\n\n  function handleClickButton() {\n    setActive(true)\n  }\n  function handleClosePanel() {\n    setActive(false)\n  }\n  return active ? (\n    <TrackChangesPanel onClose={handleClosePanel} />\n  ) : (\n    <TrackChangesBtn onClick={handleClickButton} />\n  )\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport { EditorView } from 'prosemirror-view'\n\nimport { TrackChangesContext } from './state/TrackChangesContext'\nimport { TrackChangesStore } from './state/TrackChangesStore'\nimport { TrackChangesControls } from './TrackChangesControls'\n\nconst CONTAINER_CLASS_NAME = '__track-changes__'\n\nfunction createOrFindPlace() {\n  let place: HTMLElement | null = document.querySelector(\n    `.${CONTAINER_CLASS_NAME}`\n  )\n\n  if (!place) {\n    place = document.createElement('div')\n    place.className = CONTAINER_CLASS_NAME\n    document.body.appendChild(place)\n  }\n\n  return place\n}\n\nexport function injectTrackChanges(view: EditorView) {\n  const place = createOrFindPlace()\n  const store = new TrackChangesStore(view)\n  ReactDOM.render(\n    <TrackChangesContext.Provider\n      value={{\n        store,\n      }}\n    >\n      <TrackChangesControls />\n    </TrackChangesContext.Provider>,\n    place\n  )\n}\n","import { Schema } from 'prosemirror-model'\n\nexport type Marks = 'bold' | 'code' | 'italic' | 'link' | 'strikethrough'\nexport type Nodes =\n  | 'blockquote'\n  | 'code_block'\n  | 'doc'\n  | 'hard_break'\n  | 'heading'\n  | 'horizontal_rule'\n  | 'image'\n  | 'paragraph'\n  | 'text'\n\nexport type ExampleSchema = Schema<Nodes, Marks>\n\nexport const schema: ExampleSchema = new Schema<Nodes, Marks>({\n  nodes: {\n    // :: NodeSpec The top level document node.\n    doc: {\n      content: 'block+',\n    },\n\n    // :: NodeSpec A plain paragraph textblock. Represented in the DOM\n    // as a `<p>` element.\n    paragraph: {\n      attrs: { dataTracked: { default: null } },\n      content: 'inline*',\n      group: 'block',\n      parseDOM: [{ tag: 'p' }],\n      toDOM() {\n        return ['p', 0]\n      },\n    },\n\n    // :: NodeSpec A blockquote (`<blockquote>`) wrapping one or more blocks.\n    blockquote: {\n      attrs: { dataTracked: { default: null } },\n      content: 'block+',\n      group: 'block',\n      defining: true,\n      parseDOM: [{ tag: 'blockquote' }],\n      toDOM() {\n        return ['blockquote', 0]\n      },\n    },\n\n    // :: NodeSpec A horizontal rule (`<hr>`).\n    horizontal_rule: {\n      group: 'block',\n      parseDOM: [{ tag: 'hr' }],\n      toDOM() {\n        return ['hr']\n      },\n    },\n\n    // :: NodeSpec A heading textblock, with a `level` attribute that\n    // should hold the number 1 to 6. Parsed and serialized as `<h1>` to\n    // `<h6>` elements.\n    heading: {\n      attrs: { level: { default: 1 } },\n      content: 'inline*',\n      group: 'block',\n      defining: true,\n      parseDOM: [\n        { tag: 'h1', attrs: { level: 1 } },\n        { tag: 'h2', attrs: { level: 2 } },\n        { tag: 'h3', attrs: { level: 3 } },\n        { tag: 'h4', attrs: { level: 4 } },\n        { tag: 'h5', attrs: { level: 5 } },\n        { tag: 'h6', attrs: { level: 6 } },\n      ],\n      toDOM(node) {\n        return ['h' + node.attrs.level, 0]\n      },\n    },\n\n    // :: NodeSpec A code listing. Disallows marks or non-text inline\n    // nodes by default. Represented as a `<pre>` element with a\n    // `<code>` element inside of it.\n    code_block: {\n      content: 'text*',\n      marks: '',\n      group: 'block',\n      code: true,\n      defining: true,\n      parseDOM: [{ tag: 'pre', preserveWhitespace: 'full' }],\n      toDOM() {\n        return ['pre', ['code', 0]]\n      },\n    },\n\n    // :: NodeSpec The text node.\n    text: {\n      group: 'inline',\n    },\n\n    // :: NodeSpec An inline image (`<img>`) node. Supports `src`,\n    // `alt`, and `href` attributes. The latter two default to the empty\n    // string.\n    image: {\n      inline: true,\n      attrs: {\n        src: {},\n        alt: { default: null },\n        title: { default: null },\n      },\n      group: 'inline',\n      draggable: true,\n      parseDOM: [\n        {\n          tag: 'img[src]',\n          getAttrs(p) {\n            const dom = p as HTMLElement\n            return {\n              src: dom.getAttribute('src'),\n              title: dom.getAttribute('title'),\n              alt: dom.getAttribute('alt'),\n            }\n          },\n        },\n      ],\n      toDOM(node) {\n        const { src, alt, title } = node.attrs\n        return ['img', { src, alt, title }]\n      },\n    },\n\n    // :: NodeSpec A hard line break, represented in the DOM as `<br>`.\n    hard_break: {\n      inline: true,\n      group: 'inline',\n      selectable: false,\n      parseDOM: [{ tag: 'br' }],\n      toDOM() {\n        return ['br']\n      },\n    },\n  },\n  marks: {\n    // :: MarkSpec A link. Has `href` and `title` attributes. `title`\n    // defaults to the empty string. Rendered and parsed as an `<a>`\n    // element.\n    link: {\n      attrs: {\n        href: {},\n        title: { default: null },\n      },\n      inclusive: false,\n      parseDOM: [\n        {\n          tag: 'a[href]',\n          getAttrs(p) {\n            const dom = p as HTMLElement\n            return {\n              href: dom.getAttribute('href'),\n              title: dom.getAttribute('title'),\n            }\n          },\n        },\n      ],\n      toDOM(node) {\n        const { href, title } = node.attrs\n        return ['a', { href, title }, 0]\n      },\n    },\n\n    // :: MarkSpec An emphasis mark. Rendered as an `<em>` element.\n    // Has parse rules that also match `<i>` and `font-style: italic`.\n    italic: {\n      parseDOM: [{ tag: 'i' }, { tag: 'em' }, { style: 'font-style=italic' }],\n      toDOM() {\n        return ['em', 0]\n      },\n    },\n\n    // :: MarkSpec A strong mark. Rendered as `<strong>`, parse rules\n    // also match `<b>` and `font-weight: bold`.\n    bold: {\n      parseDOM: [\n        { tag: 'strong' },\n        // This works around a Google Docs misbehavior where\n        // pasted content will be inexplicably wrapped in `<b>`\n        // tags with a font-weight normal.\n        {\n          tag: 'b',\n          getAttrs: (p) => {\n            const node = p as HTMLElement\n            return node.style.fontWeight != 'normal' && null\n          },\n        },\n        {\n          style: 'font-weight',\n          getAttrs: (p) => {\n            const value = p as string\n            return /^(bold(er)?|[5-9]\\d{2,})$/.test(value) && null\n          },\n        },\n      ],\n      toDOM() {\n        return ['strong', 0]\n      },\n    },\n\n    // :: MarkSpec Code font mark. Represented as a `<code>` element.\n    code: {\n      parseDOM: [{ tag: 'code' }],\n      toDOM() {\n        return ['code', 0]\n      },\n    },\n\n    strikethrough: {\n      parseDOM: [\n        { tag: 's' },\n        { tag: 'strike' },\n        { style: 'text-decoration=line-through' },\n        { style: 'text-decoration-line=line-through' },\n      ],\n      toDOM: () => ['s'],\n    }\n  },\n})\n","import React, { useEffect, useLayoutEffect, useRef } from 'react'\nimport { EditorView } from 'prosemirror-view'\nimport { EditorState, Transaction } from 'prosemirror-state'\nimport { exampleSetup } from 'prosemirror-example-setup'\n\nimport { schema } from './schema'\nimport { activeNodesMarksPlugin } from './active-nodes-marks'\nimport { trackChangesPlugin } from './track-changes/track-changes-plugin'\n\nimport { useEditorContext } from './EditorContext'\n\nimport './editor.css'\nimport './prosemirror-example-setup.css'\nimport './menu.css'\n\ninterface EditorProps {\n  className?: string\n  onEditorReady?: (view: EditorView) => void\n  onEdit?: (state: EditorState) => void\n}\n\nexport function PMEditor(props: EditorProps) {\n  const { className = '' } = props\n  const editorViewRef = useRef(null)\n  const editorRef = useRef<EditorView | null>(null)\n  const ctx = useEditorContext()\n\n  useLayoutEffect(() => {\n    const state = createEditorState()\n    const editorViewDOM = editorViewRef.current\n    if (editorViewDOM) {\n      editorRef.current = createEditorView(editorViewDOM, state)\n      ctx.viewProvider.init(editorRef.current)\n      props.onEditorReady && props?.onEditorReady(editorRef.current)\n    }\n    return () => {\n      editorRef.current?.destroy()\n    }\n  }, [])\n\n  function createEditorState() {\n    return EditorState.create({\n      schema,\n      plugins: exampleSetup({ schema }).concat(\n        activeNodesMarksPlugin(),\n        trackChangesPlugin(),\n      ),\n    })\n  }\n\n  function createEditorView(element: HTMLDivElement, state: EditorState) {\n    const view = new EditorView({ mount: element }, {\n      state,\n      dispatchTransaction,\n    })\n    // @ts-ignore\n    if (window) window.editorView = view\n    return view\n  }\n\n  function dispatchTransaction(transaction: Transaction) {\n    if (!editorRef.current) {\n      return\n    }\n    const oldEditorState = editorRef.current.state\n    const editorState = oldEditorState.apply(transaction)\n    editorRef.current.updateState(editorState)\n    ctx.pluginStateProvider.updatePluginListeners(oldEditorState, editorState)\n    if (props.onEdit) {\n      props.onEdit(editorState)\n    }\n  }\n\n  return (\n    <div id=\"example-editor\" ref={editorViewRef} className={className}/>\n  )\n}\n","import { EditorView } from 'prosemirror-view'\nimport { EditorState } from 'prosemirror-state'\nimport { ExampleSchema } from 'pm/schema'\n\nexport class EditorStore {\n\n  _view?: EditorView<ExampleSchema>\n  jsonEditorState?: {[key: string]: any}\n  localStorageKey: string\n\n  constructor(key: string) {\n    this.localStorageKey = key\n    if (typeof window !== 'undefined') {\n      const existing = localStorage.getItem(this.localStorageKey)\n      if (existing && existing !== null && existing.length > 0) {\n        let stored = JSON.parse(existing)\n        this.jsonEditorState = stored\n      }\n    }\n  }\n\n  setEditorView = (view: EditorView) => {\n    this._view = view\n    if (this.jsonEditorState) {\n      const state = EditorState.fromJSON(\n        {\n          schema: this._view.state.schema,\n          plugins: this._view.state.plugins,\n        },\n        this.jsonEditorState\n      )\n      this._view.updateState(state)\n    }\n  }\n\n  syncCurrentEditorState = () => {\n    localStorage.setItem(this.localStorageKey, JSON.stringify(this._view?.state.toJSON()))\n  }\n}","import React, { useMemo } from 'react'\nimport styled from 'styled-components'\nimport debounce from 'lodash.debounce'\n\nimport { EditorView } from 'prosemirror-view'\nimport { applyDevTools } from 'prosemirror-dev-tools'\n\nimport { Toolbar } from './Toolbar'\nimport { SelectUser } from './SelectUser'\nimport { ChangesList } from './ChangesList'\nimport { injectTrackChanges } from './track-changes-panel'\n\nimport { PMEditor } from 'pm/PMEditor'\nimport { EditorStore } from './EditorStore'\nimport { ReactEditorContext } from 'pm/EditorContext'\nimport { createDefaultProviders } from 'pm/Providers'\n\nexport function Editor() {\n  const editorStore = useMemo(() => new EditorStore('track-changes'), [])\n  const debouncedSync = useMemo(() => debounce(editorStore.syncCurrentEditorState, 250), [])\n\n  function handleEdit() {\n    debouncedSync()\n  }\n  function handleEditorReady(view: EditorView) {\n    editorStore.setEditorView(view)\n    applyDevTools(view)\n    injectTrackChanges(view)\n  }\n  return (\n    <ReactEditorContext.Provider value={createDefaultProviders()}>\n      <SelectUser/>\n      <EditorWrapper>\n        <div>\n          <Toolbar />\n          <PMEditor\n            onEdit={handleEdit}\n            onEditorReady={handleEditorReady}\n          />\n        </div>\n        <ChangesList className=\"changes-list\"/>\n      </EditorWrapper>\n    </ReactEditorContext.Provider>\n  )\n}\n\nconst EditorWrapper = styled.div`\n  display: flex;\n  margin-top: 1rem;\n  width: 100%;\n  .changes-list {\n    margin-left: 1rem;\n  }\n`","import React from 'react'\nimport styled from 'styled-components'\n\nimport { PageHeader } from '../components/PageHeader'\nimport { Editor } from '../components/Editor'\n\nexport function FrontPage() {\n  return (\n    <Container>\n      <PageHeader/>\n      <Editor/>\n    </Container>\n  )\n}\n\nconst Container = styled.div``\n","import * as React from 'react'\nimport { BrowserRouter, Redirect, Switch } from 'react-router-dom'\n\nimport { WrappedRoute } from './components/WrappedRoute'\n\nimport { FrontPage } from './pages/FrontPage'\n\nexport const Routes = () => (\n  <BrowserRouter basename={process.env.PUBLIC_URL}>\n    <Switch>\n      <WrappedRoute exact path=\"/\" component={FrontPage}/>\n      <Redirect to=\"/\" />\n    </Switch>\n  </BrowserRouter>\n)\n","import * as React from 'react'\nimport { render } from 'react-dom'\n\nimport { Routes } from './routes'\n\nimport './index.css'\n\nrender(\n  <Routes />,\n  document.getElementById('root')\n)\n"],"sourceRoot":""}